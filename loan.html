<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan Management - EasyKharcha</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
  <style>
    /* ========== BASE STYLES ========== */
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --secondary: #f8f9fa;
      --accent: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
      --radius: 12px;
    }
    
    .dark-mode {
      --primary: #3b82f6;
      --primary-light: #60a5fa;
      --secondary: #1e293b;
      --accent: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --text: #f1f5f9;
      --text-light: #94a3b8;
      --border: #334155;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      background: #0f172a;
      color: var(--text);
    }
    
    .dark-mode header {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
    }
    
    .dark-mode .card, 
    .dark-mode .stat-card, 
    .dark-mode .filters {
      background: #1e293b;
      color: var(--text);
    }
    
    .dark-mode input, 
    .dark-mode select, 
    .dark-mode textarea {
      background: #1e293b;
      color: var(--text);
      border-color: var(--border);
    }
    
    .dark-mode .table-container {
      border-color: var(--border);
    }
    
    .dark-mode th {
      background: #1e293b;
    }
    
    .dark-mode td {
      border-bottom-color: var(--border);
      color: var(--text);
    }
    
    .dark-mode .bottom-nav {
      background: #1e293b;
      border-top-color: var(--border);
    }
    
    .dark-mode .bottom-nav-link {
      color: var(--text-light);
    }
    
    .dark-mode .bottom-nav-link.active {
      color: var(--primary-light);
    }
    
    .dark-mode .user-menu {
      background: #1e293b;
    }
    
    .dark-mode .user-menu-item {
      color: var(--text);
      border-bottom-color: var(--border);
    }
    
    .dark-mode .user-menu-item:hover {
      background: #334155;
    }
    
    /* ========== URDU MODE (RTL) ========== */
    .urdu-mode {
      direction: rtl;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: right;
    }
    
    .urdu-mode .logo, 
    .urdu-mode .nav-links, 
    .urdu-mode .user-profile, 
    .urdu-mode .card-header, 
    .urdu-mode .table-actions, 
    .urdu-mode .action-cell, 
    .urdu-mode .loan-actions, 
    .urdu-mode .filter-group, 
    .urdu-mode .search-box {
      direction: ltr;
    }
    
    .urdu-mode .stat-title, 
    .urdu-mode .stat-value, 
    .urdu-mode .stat-trend,
    .urdu-mode .loan-name, 
    .urdu-mode .loan-amount, 
    .urdu-mode .detail-label, 
    .urdu-mode .loan-type,
    .urdu-mode .form-group label, 
    .urdu-mode .filter-label,
    .urdu-mode .page-title, 
    .urdu-mode .card-title, 
    .urdu-mode .modal-title,
    .urdu-mode .footer-section {
      text-align: right;
    }
    
    .urdu-mode .empty-state {
      text-align: center;
    }
    
    .urdu-mode .footer-section h3::after {
      left: auto;
      right: 0;
    }
    
    .urdu-mode .loan-details {
      text-align: right;
    }
    
    .urdu-mode .action-cell {
      justify-content: flex-start;
    }
    
    .urdu-mode .table-container table {
      text-align: right;
    }
    
    .urdu-mode .table-container table td:first-child,
    .urdu-mode .table-container table th:first-child {
      text-align: right;
    }
    
    .urdu-mode .table-container table td:last-child,
    .urdu-mode .table-container table th:last-child {
      text-align: left;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: #f8fafc;
      color: var(--text);
      line-height: 1.6;
      padding: 0;
      min-height: 100vh;
      padding-bottom: 60px; /* Space for bottom nav */
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ========== HEADER STYLES ========== */
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 16px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: background 0.3s ease;
    }
    
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      font-size: 28px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* ========== PAGE HEADER & STATS ========== */
    .page-header {
      margin: 25px 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .page-title {
      font-size: 26px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }
    
    .stats-container {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      width: 100%;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      border-left: 4px solid var(--success);
      flex: 1;
      min-width: calc(33.333% - 11px);
      margin-bottom: 10px;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card.warning {
      border-left-color: var(--warning);
    }
    
    .stat-card.danger {
      border-left-color: var(--accent);
    }
    
    .stat-title {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 5px;
    }
    
    .stat-trend {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .trend-positive {
      color: var(--success);
    }
    
    .trend-negative {
      color: var(--accent);
    }
    
    /* ========== FILTERS SECTION ========== */
    .filters {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      background: white;
      padding: 18px 22px;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      transition: background 0.3s ease;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .filter-label {
      font-weight: 500;
      color: var(--text-light);
      font-size: 14px;
    }
    
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-box input {
      padding: 11px 15px 11px 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      min-width: 250px;
      background: #f8fafc;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      color: var(--text-light);
      font-size: 15px;
    }
    
    .filter-select {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      background: #f8fafc;
      min-width: 150px;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    
    .filter-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filter-btn:hover {
      background: var(--primary-light);
    }
    
    /* ========== ADVANCED FILTERS (HIDDEN BY DEFAULT) ========== */
    .advanced-filters {
      display: none;
      width: 100%;
      padding: 15px;
      background: #f8fafc;
      border-radius: var(--radius);
      margin-top: 10px;
      transition: all 0.3s ease;
    }
    
    .advanced-filters.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; height: 0; }
      to { opacity: 1; height: auto; }
    }
    
    .toggle-filters {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    
    /* ========== CUSTOMER/LEDGER CARDS ========== */
    .customer-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .customer-card {
      background: white;
      border-radius: var(--radius);
      padding: 15px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .customer-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    .customer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .customer-name {
      font-weight: 600;
      font-size: 18px;
    }
    
    .customer-balance {
      font-weight: 700;
      font-size: 18px;
    }
    
    .balance-positive {
      color: var(--success);
    }
    
    .balance-negative {
      color: var(--accent);
    }
    
    .customer-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .detail-label {
      color: var(--text-light);
      font-weight: 500;
    }
    
    .customer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 15px;
    }
    
    /* ========== LOAN ITEMS IN LEDGER ========== */
    .loan-items {
      margin-top: 15px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    
    .loan-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed var(--border);
    }
    
    .loan-item:last-child {
      border-bottom: none;
    }
    
    .loan-item-date {
      color: var(--text-light);
      font-size: 13px;
    }
    
    .loan-item-amount {
      font-weight: 600;
    }
    
    .loan-item-type {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 5px;
    }
    
    .type-given-bg {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .type-taken-bg {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent);
    }
    
    /* ========== TABLE STYLES (DESKTOP) ========== */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
      margin-top: 10px;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid var(--border);
      transition: border-color 0.3s ease;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px;
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      padding: 14px 18px;
      text-align: left;
      font-weight: 500;
      position: sticky;
      top: 0;
      transition: background-color 0.3s ease;
    }
    
    th:first-child {
      border-top-left-radius: var(--radius);
    }
    
    th:last-child {
      border-top-right-radius: var(--radius);
    }
    
    td {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 14px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    tbody tr {
      transition: var(--transition);
    }
    
    tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .type-given {
      color: var(--success);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .type-taken {
      color: var(--accent);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      font-size: 13px;
    }
    
    .edit-btn {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .edit-btn:hover {
      background: rgba(16, 185, 129, 0.2);
    }
    
    .delete-btn {
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent);
    }
    
    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }
    
    .whatsapp-btn {
      background: rgba(37, 211, 102, 0.1);
      color: #25D366;
    }
    
    .whatsapp-btn:hover {
      background: rgba(37, 211, 102, 0.2);
    }
    
    /* ========== STATUS BADGES ========== */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .status-closed {
      background: rgba(100, 116, 139, 0.15);
      color: var(--text-light);
    }
    
    .status-overdue {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent);
    }
    
    /* ========== FLOATING ACTION BUTTON ========== */
    .fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      cursor: pointer;
      z-index: 99;
      transition: var(--transition);
      display: none;
    }
    
    .fab:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    .fab-menu {
      position: absolute;
      bottom: 70px;
      right: 0;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      width: 200px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: var(--transition);
    }
    
    .fab:hover .fab-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .fab-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 14px;
      transition: var(--transition);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    
    .fab-item:last-child {
      border-bottom: none;
    }
    
    .fab-item:hover {
      background: #f1f5f9;
      color: var(--primary);
    }
    
    /* ========== MODAL STYLES ========== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: modalOpen 0.3s ease;
    }
    
    @keyframes modalOpen {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 20px;
      color: var(--primary);
      font-weight: 600;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--accent);
    }
    
    .modal-body {
      padding: 20px;
    }
    
    /* ========== FORM STYLES ========== */
    .form-group {
      margin-bottom: 18px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .form-group input, 
    .form-group select, 
    .form-group textarea {
      width: 100%;
      padding: 13px 15px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      transition: var(--transition);
      background: #f8fafc;
    }
    
    .form-group input:focus, 
    .form-group select:focus, 
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: var(--text);
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    /* ========== PRODUCT ITEMS IN LOAN FORM ========== */
    .product-items {
      margin-top: 15px;
    }
    
    .product-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .product-select {
      flex: 2;
    }
    
    .product-qty, .product-rate {
      flex: 1;
    }
    
    .product-remove {
      color: var(--accent);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .product-remove:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    /* ========== TOAST NOTIFICATION ========== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: white;
      padding: 15px 25px;
      border-radius: var(--radius);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
    }
    
    .empty-state i {
      font-size: 60px;
      color: #cbd5e1;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--text);
    }
    
    .empty-state p {
      color: var(--text-light);
      margin-bottom: 20px;
    }
    
    /* ========== LOADING SPINNER ========== */
    .loading {
      display: flex;
      justify-content: center;
      padding: 30px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(37, 99, 235, 0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== BOTTOM NAVIGATION ========== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    
    .bottom-nav-link {
      text-align: center;
      color: #555;
      font-size: 12px;
      flex: 1;
      padding: 5px 0;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    
    .bottom-nav-link i {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
    }
    
    .bottom-nav-link.active {
      color: var(--primary);
    }
    
    .bottom-nav-link:hover {
      color: var(--primary);
    }
    
    /* ========== RESPONSIVE ADJUSTMENTS ========== */
    @media (max-width: 768px) {
      .header-container {
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .stats-container {
        width: 100%;
      }
      
      .stat-card {
        min-width: 100%;
      }
      
      .filters {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .search-box input {
        min-width: 100%;
      }
      
      .fab {
        display: flex;
      }
      
      /* Show mobile cards and hide table */
      .table-container {
        display: none;
      }
      
      .customer-cards {
        display: block;
      }
    }
    
    @media (min-width: 769px) {
      .table-container {
        display: block;
      }
      
      .customer-cards {
        display: none;
      }
    }
    
    @media (max-width: 480px) {
      .header-container {
        padding: 0 15px;
      }
      
      .logo-text {
        font-size: 20px;
      }
      
      .page-title {
        font-size: 22px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .product-item {
        flex-wrap: wrap;
      }
      
      .product-select, .product-qty, .product-rate {
        flex: 100%;
      }
    }
    
    /* ========== INPUT VALIDATION STYLES ========== */
    .input-error {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
    }
    
    .error-message {
      color: var(--accent);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .form-group.error .error-message {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="logo-text">EasyKharcha</div>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="page-header">
      <h1 class="page-title" data-translate="Loan Management">
        <i class="fas fa-hand-holding-usd"></i> Loan Management
      </h1>
      
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-title"><i class="fas fa-arrow-up"></i> <span data-translate="Total Given">Total Given</span></div>
          <div class="stat-value" id="totalGiven">RS 0</div>
          <div class="stat-trend trend-negative" id="givenTrend">
            <i class="fas fa-arrow-up"></i> 0% from last month
          </div>
        </div>

        <div class="stat-card warning">
          <div class="stat-title"><i class="fas fa-arrow-down"></i> <span data-translate="Total Received">Total Received</span></div>
          <div class="stat-value" id="totalReceived">RS 0</div>
          <div class="stat-trend trend-positive" id="receivedTrend">
            <i class="fas fa-arrow-down"></i> 0% from last month
          </div>
        </div>

        <div class="stat-card danger">
          <div class="stat-title"><i class="fas fa-balance-scale"></i> <span data-translate="Net Balance">Net Balance</span></div>
          <div class="stat-value" id="netBalance">RS 0</div>
          <div class="stat-trend trend-positive" id="balanceTrend">
            <i class="fas fa-arrow-up"></i> 0% from last month
          </div>
        </div>
      </div>
    </div>
    
    <div class="filters">
      <div class="filter-group">
        <span class="filter-label" data-translate="Filter by:">Filter by:</span>
        <select class="filter-select" id="typeFilter">
          <option value="all" data-translate="All Loans">All Loans</option>
          <option value="given" data-translate="Given Loans">Given Loans</option>
          <option value="taken" data-translate="Taken Loans">Taken Loans</option>
        </select>
        
        <select class="filter-select" id="statusFilter">
          <option value="all" data-translate="All Status">All Status</option>
          <option value="active" data-translate="Active Loans">Active Loans</option>
          <option value="closed" data-translate="Closed Loans">Closed Loans</option>
          <option value="overdue" data-translate="Overdue Loans">Overdue Loans</option>
        </select>
        
        <button class="filter-btn" id="applyFilters">
          <i class="fas fa-filter"></i> <span data-translate="Apply">Apply</span>
        </button>
      </div>
      
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" placeholder="Search by name or phone..." data-placeholder="Search by name or phone...">
      </div>
    </div>
    
    <!-- Advanced Filters (Hidden by Default) -->
    <div class="advanced-filters" id="advancedFilters">
      <div class="form-row">
        <div class="form-group">
          <label for="dateFrom"><i class="fas fa-calendar"></i> <span data-translate="From Date">From Date</span></label>
          <input type="date" id="dateFrom">
        </div>
        
        <div class="form-group">
          <label for="dateTo"><i class="fas fa-calendar"></i> <span data-translate="To Date">To Date</span></label>
          <input type="date" id="dateTo">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="minAmount"><i class="fas fa-rupee-sign"></i> <span data-translate="Min Amount">Min Amount</span></label>
          <input type="number" id="minAmount" placeholder="Minimum amount">
        </div>
        
        <div class="form-group">
          <label for="maxAmount"><i class="fas fa-rupee-sign"></i> <span data-translate="Max Amount">Max Amount</span></label>
          <input type="number" id="maxAmount" placeholder="Maximum amount">
        </div>
      </div>
    </div>
    
    <button class="toggle-filters" id="toggleFilters">
      <i class="fas fa-sliders-h"></i> <span data-translate="Advanced Filters">Advanced Filters</span>
    </button>
    
    <!-- Customer Cards (Mobile View) -->
    <div class="customer-cards" id="customerCards">
      <!-- Customer cards will be populated here by JavaScript -->
    </div>
    
    <!-- Loans Table (Desktop View) -->
    <div class="table-container">
      <table id="loansTable">
        <thead>
          <tr>
            <th data-translate="Customer">Customer</th>
            <th data-translate="Phone">Phone</th>
            <th data-translate="Given">Given</th>
            <th data-translate="Received">Received</th>
            <th data-translate="Balance">Balance</th>
            <th data-translate="Status">Status</th>
            <th data-translate="Last Activity">Last Activity</th>
            <th data-translate="Actions">Actions</th>
          </tr>
        </thead>
        <tbody id="loansTableBody">
          <!-- Loans will be populated here by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Floating Action Button with Menu -->
  <div class="fab" id="fabButton">
    <i class="fas fa-plus"></i>
    <div class="fab-menu">
      <div class="fab-item" id="addCustomerBtn">
        <i class="fas fa-user-plus"></i> <span data-translate="Add Customer">Add Customer</span>
      </div>
      <div class="fab-item" id="addLoanBtn">
        <i class="fas fa-hand-holding-usd"></i> <span data-translate="New Loan">New Loan</span>
      </div>
      <div class="fab-item" id="addRepaymentBtn">
        <i class="fas fa-money-bill-wave"></i> <span data-translate="Record Repayment">Record Repayment</span>
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Loan added successfully!</span>
  </div>
  
  <!-- Modals -->
  <!-- Add Customer Modal -->
  <div class="modal" id="customerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="customerModalTitle" data-translate="Add Customer">Add Customer</h3>
        <button class="close-modal" id="closeCustomerModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          <div class="form-row">
            <div class="form-group">
              <label for="customerName"><i class="fas fa-user"></i> <span data-translate="Full Name">Full Name</span></label>
              <input type="text" id="customerName" placeholder="Enter full name" required>
              <div class="error-message" id="nameError">Name is required</div>
            </div>
            
            <div class="form-group">
              <label for="customerPhone"><i class="fas fa-phone"></i> <span data-translate="Phone Number">Phone Number</span></label>
              <input type="tel" id="customerPhone" placeholder="Enter phone number" required>
              <div class="error-message" id="phoneError">Phone is required</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="customerAddress"><i class="fas fa-map-marker-alt"></i> <span data-translate="Address (Optional)">Address (Optional)</span></label>
            <textarea id="customerAddress" placeholder="Enter address" rows="2"></textarea>
          </div>
          
          <div class="form-group">
            <label for="customerPhoto"><i class="fas fa-camera"></i> <span data-translate="Photo (Optional)">Photo (Optional)</span></label>
            <input type="file" id="customerPhoto" accept="image/*">
          </div>
          
          <div class="form-group">
            <label for="openingBalance"><i class="fas fa-rupee-sign"></i> <span data-translate="Opening Balance">Opening Balance</span></label>
            <input type="number" id="openingBalance" placeholder="Enter opening balance" value="0">
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelCustomer">
              <span data-translate="Cancel">Cancel</span>
            </button>
            <button type="submit" class="btn btn-primary" id="saveCustomer">
              <i class="fas fa-save"></i> <span data-translate="Save Customer">Save Customer</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Add Loan Modal -->
  <div class="modal" id="loanModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="loanModalTitle" data-translate="New Loan">New Loan</h3>
        <button class="close-modal" id="closeLoanModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="loanForm">
          <div class="form-row">
            <div class="form-group">
              <label for="loanCustomer"><i class="fas fa-user"></i> <span data-translate="Customer">Customer</span></label>
              <select id="loanCustomer" required>
                <option value="" data-translate="Select Customer">Select Customer</option>
                <!-- Customers will be populated here -->
              </select>
              <div class="error-message" id="customerError">Customer is required</div>
            </div>
            
            <div class="form-group">
              <label for="loanDate"><i class="fas fa-calendar"></i> <span data-translate="Date">Date</span></label>
              <input type="date" id="loanDate" required>
              <div class="error-message" id="dateError">Date is required</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="loanDueDate"><i class="fas fa-calendar-check"></i> <span data-translate="Due Date">Due Date</span></label>
            <input type="date" id="loanDueDate">
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-boxes"></i> <span data-translate="Products">Products</span></label>
            <div class="product-items" id="productItems">
              <!-- Product items will be added here -->
            </div>
            <button type="button" class="btn btn-secondary" id="addProduct" style="margin-top: 10px;">
              <i class="fas fa-plus"></i> <span data-translate="Add Product">Add Product</span>
            </button>
            <div class="error-message" id="productError">At least one product is required</div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="loanDiscount"><i class="fas fa-tag"></i> <span data-translate="Discount">Discount</span></label>
              <input type="number" id="loanDiscount" placeholder="Enter discount" value="0" min="0">
            </div>
            
            <div class="form-group">
              <label for="loanTax"><i class="fas fa-percentage"></i> <span data-translate="Tax">Tax</span></label>
              <input type="number" id="loanTax" placeholder="Enter tax" value="0" min="0">
            </div>
          </div>
          
          <div class="form-group">
            <label for="loanTotal"><i class="fas fa-calculator"></i> <span data-translate="Total Amount">Total Amount</span></label>
            <input type="number" id="loanTotal" readonly>
          </div>
          
          <div class="form-group">
            <label for="loanNote"><i class="fas fa-sticky-note"></i> <span data-translate="Notes (Optional)">Notes (Optional)</span></label>
            <textarea id="loanNote" placeholder="Enter any notes"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelLoan">
              <span data-translate="Cancel">Cancel</span>
            </button>
            <button type="submit" class="btn btn-primary" id="saveLoan">
              <i class="fas fa-save"></i> <span data-translate="Save Loan">Save Loan</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Record Repayment Modal -->
  <div class="modal" id="repaymentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" data-translate="Record Repayment">Record Repayment</h3>
        <button class="close-modal" id="closeRepaymentModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="repaymentForm">
          <div class="form-row">
            <div class="form-group">
              <label for="repaymentCustomer"><i class="fas fa-user"></i> <span data-translate="Customer">Customer</span></label>
              <select id="repaymentCustomer" required>
                <option value="" data-translate="Select Customer">Select Customer</option>
                <!-- Customers will be populated here -->
              </select>
              <div class="error-message" id="repaymentCustomerError">Customer is required</div>
            </div>
            
            <div class="form-group">
              <label for="repaymentLoan"><i class="fas fa-file-invoice-dollar"></i> <span data-translate="Loan">Loan</span></label>
              <select id="repaymentLoan" required>
                <option value="" data-translate="Select Loan">Select Loan</option>
                <!-- Loans will be populated here -->
              </select>
              <div class="error-message" id="repaymentLoanError">Loan is required</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="repaymentAmount"><i class="fas fa-rupee-sign"></i> <span data-translate="Amount">Amount</span></label>
              <input type="number" id="repaymentAmount" placeholder="Enter amount" required min="1">
              <div class="error-message" id="repaymentAmountError">Amount must be greater than 0</div>
            </div>
            
            <div class="form-group">
              <label for="repaymentDate"><i class="fas fa-calendar"></i> <span data-translate="Date">Date</span></label>
              <input type="date" id="repaymentDate" required>
              <div class="error-message" id="repaymentDateError">Date is required</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="repaymentMethod"><i class="fas fa-money-bill-wave"></i> <span data-translate="Payment Method">Payment Method</span></label>
            <select id="repaymentMethod">
              <option value="cash" data-translate="Cash">Cash</option>
              <option value="bank" data-translate="Bank Transfer">Bank Transfer</option>
              <option value="cheque" data-translate="Cheque">Cheque</option>
              <option value="upi" data-translate="UPI">UPI</option>
              <option value="other" data-translate="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="repaymentNote"><i class="fas fa-sticky-note"></i> <span data-translate="Notes (Optional)">Notes (Optional)</span></label>
            <textarea id="repaymentNote" placeholder="Enter any notes"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelRepayment">
              <span data-translate="Cancel">Cancel</span>
            </button>
            <button type="submit" class="btn btn-primary" id="saveRepayment">
              <i class="fas fa-save"></i> <span data-translate="Record Payment">Record Payment</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Customer Detail Modal -->
  <div class="modal" id="customerDetailModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title" id="customerDetailTitle">Customer Details</h3>
        <button class="close-modal" id="closeCustomerDetailModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" style="text-align: center;">
            <img id="customerDetailPhoto" src="https://via.placeholder.com/150" alt="Customer Photo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
            <h3 id="customerDetailName">Customer Name</h3>
            <p id="customerDetailPhone"><i class="fas fa-phone"></i> +1234567890</p>
            <p id="customerDetailAddress"><i class="fas fa-map-marker-alt"></i> Address not provided</p>
          </div>
          
          <div class="form-group">
            <div class="stat-card" style="margin-bottom: 15px;">
              <div class="stat-title"><i class="fas fa-arrow-up"></i> <span data-translate="Total Given">Total Given</span></div>
              <div class="stat-value" id="customerTotalGiven">RS 0</div>
            </div>
            
            <div class="stat-card warning" style="margin-bottom: 15px;">
              <div class="stat-title"><i class="fas fa-arrow-down"></i> <span data-translate="Total Received">Total Received</span></div>
              <div class="stat-value" id="customerTotalReceived">RS 0</div>
            </div>
            
            <div class="stat-card danger">
              <div class="stat-title"><i class="fas fa-balance-scale"></i> <span data-translate="Balance">Balance</span></div>
              <div class="stat-value" id="customerBalance">RS 0</div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-filter"></i> <span data-translate="Date Range">Date Range</span></label>
          <div class="form-row">
            <div class="form-group">
              <input type="date" id="customerDateFrom">
            </div>
            
            <div class="form-group">
              <input type="date" id="customerDateTo">
            </div>
            
            <div class="form-group">
              <button type="button" class="btn btn-primary" id="applyCustomerFilter" style="width: 100%;">
                <i class="fas fa-filter"></i> <span data-translate="Apply">Apply</span>
              </button>
            </div>
          </div>
        </div>
        
        <div class="table-container">
          <table id="customerLedgerTable">
            <thead>
              <tr>
                <th data-translate="Date">Date</th>
                <th data-translate="Type">Type</th>
                <th data-translate="Amount">Amount</th>
                <th data-translate="Balance">Balance</th>
                <th data-translate="Note">Note</th>
              </tr>
            </thead>
            <tbody id="customerLedgerBody">
              <!-- Ledger entries will be populated here -->
            </tbody>
          </table>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="whatsappCustomer">
            <i class="fab fa-whatsapp"></i> <span data-translate="Send Reminder">Send Reminder</span>
          </button>
          <button type="button" class="btn btn-secondary" id="exportCustomerPDF">
            <i class="fas fa-file-pdf"></i> <span data-translate="Export PDF">Export PDF</span>
          </button>
          <button type="button" class="btn btn-primary" id="addCustomerTransaction">
            <i class="fas fa-plus"></i> <span data-translate="Add Transaction">Add Transaction</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- WhatsApp Reminder Modal -->
  <div class="modal" id="whatsappModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fab fa-whatsapp" style="color: #25D366;"></i> <span data-translate="Send WhatsApp Reminder">Send WhatsApp Reminder</span>
        </h3>
        <button class="close-modal" id="closeWhatsappModal">&times;</button>
      </div>
      <div class="modal-body">
        <p data-translate="This message will be sent to the customer:">This message will be sent to the customer:</p>
        <textarea id="whatsappMessage" placeholder="Customize your message..." style="width: 100%; min-height: 120px; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px;"></textarea>
        <p><small data-translate="Note: You'll need to select the contact manually in WhatsApp">Note: You'll need to select the contact manually in WhatsApp</small></p>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancelWhatsapp">
          <span data-translate="Cancel">Cancel</span>
        </button>
        <button type="button" class="btn btn-primary" id="sendWhatsapp" style="background-color: #25D366;">
          <i class="fab fa-whatsapp"></i> <span data-translate="Open WhatsApp">Open WhatsApp</span>
        </button>
      </div>
    </div>
  </div>
  
  <nav class="bottom-nav">
    <a href="profile.html" class="bottom-nav-link">
      <i class="fas fa-home"></i><span data-translate="Dashboard">profile</span>
    </a>
    <a href="loan.html" class="bottom-nav-link active">
      <i class="fas fa-money-bill-wave"></i><span data-translate="Loan">Loan</span>
    </a>
    <a href="dashboard.html" class="bottom-nav-link">
      <i class="fas fa-user-circle"></i><span data-translate="Profile">dashboard</span>
    </a>
  </nav>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // ========== FIREBASE CONFIGURATION ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDHGd2EAJVUUYXa50G65GkutoiiHz9qtn8",
      authDomain: "easykharcha.firebaseapp.com",
      projectId: "easykharcha",
      storageBucket: "easykharcha.appspot.com",
      messagingSenderId: "735642025618",
      appId: "1:735642025618:web:eacc16213b61c48c93f04b",
      measurementId: "G-JF3E4QMZQN"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // ========== GLOBAL VARIABLES ==========
    let customers = [];
    let loans = [];
    let repayments = [];
    let products = [];
    let selectedCustomer = null;
    let selectedLoan = null;
    let editingCustomerId = null;
    let editingLoanId = null;
    
    // ========== UTILITY FUNCTIONS ==========
    function formatCurrency(amount) {
      return 'RS ' + amount.toLocaleString('en-IN');
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    }
    
    function getStatusBadge(status) {
      switch (status) {
        case 'active':
          return '<span class="status-badge status-active"><i class="fas fa-circle-notch"></i> Active</span>';
        case 'closed':
          return '<span class="status-badge status-closed"><i class="fas fa-check-circle"></i> Closed</span>';
        case 'overdue':
          return '<span class="status-badge status-overdue"><i class="fas fa-exclamation-circle"></i> Overdue</span>';
        default:
          return '<span class="status-badge">-</span>';
      }
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function calculateLoanTotal() {
      let subtotal = 0;
      const productItems = document.getElementById('productItems');
      const productRows = productItems.querySelectorAll('.product-item');
      let hasValidProduct = false;
      
      productRows.forEach(row => {
        const qty = parseFloat(row.querySelector('.product-qty').value) || 0;
        const rate = parseFloat(row.querySelector('.product-rate').value) || 0;
        
        if (qty > 0 && rate > 0) {
          subtotal += qty * rate;
          hasValidProduct = true;
        }
      });
      
      const discount = parseFloat(document.getElementById('loanDiscount').value) || 0;
      const tax = parseFloat(document.getElementById('loanTax').value) || 0;
      
      const total = subtotal - discount + (subtotal * (tax / 100));
      document.getElementById('loanTotal').value = total.toFixed(2);
      
      // Update error state
      const productError = document.getElementById('productError');
      if (!hasValidProduct) {
        productError.style.display = 'block';
      } else {
        productError.style.display = 'none';
      }
    }
    
    function updateLoanStatus(loanId) {
      const loan = loans.find(l => l.id === loanId);
      if (!loan) return;

      const loanRepayments = repayments.filter(r => r.loanId === loanId);
      const totalRepaid = loanRepayments.reduce((sum, r) => r.amount ? sum + r.amount : sum, 0);
      
      let status = 'active';
      if (totalRepaid >= loan.total) {
        status = 'closed';
      } else if (loan.dueDate && new Date(loan.dueDate) < new Date()) {
        status = 'overdue';
      }

      if (loan.status !== status) {
        db.collection("loans").doc(loanId).update({ status });
      }
    }
    
    // ========== MODAL FUNCTIONS ==========
    function openCustomerModal(customer = null) {
      editingCustomerId = customer?.id || null;
      
      if (customer) {
        document.getElementById('customerModalTitle').textContent = 'Edit Customer';
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerPhone').value = customer.phone || '';
        document.getElementById('customerAddress').value = customer.address || '';
        document.getElementById('openingBalance').value = customer.openingBalance || 0;
        
        if (customer.photoURL) {
          document.getElementById('customerDetailPhoto').src = customer.photoURL;
        }
      } else {
        document.getElementById('customerModalTitle').textContent = 'Add Customer';
        document.getElementById('customerForm').reset();
        document.getElementById('customerDetailPhoto').src = 'https://via.placeholder.com/150';
      }
      
      document.getElementById('customerModal').style.display = 'flex';
    }
    
    function openLoanModal(loan = null) {
      editingLoanId = loan?.id || null;
      
      if (loan) {
        document.getElementById('loanModalTitle').textContent = 'Edit Loan';
        document.getElementById('loanCustomer').value = loan.customerId;
        document.getElementById('loanDate').value = loan.date;
        document.getElementById('loanDueDate').value = loan.dueDate || '';
        document.getElementById('loanDiscount').value = loan.discount || 0;
        document.getElementById('loanTax').value = loan.tax || 0;
        document.getElementById('loanTotal').value = loan.total || 0;
        document.getElementById('loanNote').value = loan.note || '';
        
        // Render product items
        const productItems = document.getElementById('productItems');
        productItems.innerHTML = '';
        
        if (loan.items && loan.items.length > 0) {
          loan.items.forEach(item => {
            addProductRow(item);
          });
        } else {
          addProductRow();
        }
      } else {
        document.getElementById('loanModalTitle').textContent = 'New Loan';
        document.getElementById('loanForm').reset();
        document.getElementById('loanDate').valueAsDate = new Date();
        
        // Set default due date (30 days from now)
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('loanDueDate').valueAsDate = dueDate;
        
        renderLoanProductsDropdown();
      }
      
      document.getElementById('loanModal').style.display = 'flex';
    }
    
    function openRepaymentModal() {
      document.getElementById('repaymentForm').reset();
      document.getElementById('repaymentDate').valueAsDate = new Date();
      document.getElementById('repaymentModal').style.display = 'flex';
    }
    
    function viewCustomerDetails(customerId) {
      selectedCustomer = customers.find(c => c.id === customerId);
      if (!selectedCustomer) return;
      
      // Set default date range (last 30 days)
      const toDate = new Date();
      const fromDate = new Date();
      fromDate.setDate(toDate.getDate() - 30);
      
      document.getElementById('customerDateFrom').valueAsDate = fromDate;
      document.getElementById('customerDateTo').valueAsDate = toDate;
      
      renderCustomerLedger(customerId, fromDate, toDate);
      document.getElementById('customerDetailModal').style.display = 'flex';
    }
    
    function openWhatsappModal(customer) {
      selectedCustomer = customer;
      
      // Generate default message
      let message = `Hi ${customer.name},\n\n`;
      message += `This is a friendly reminder about your outstanding balance with us.\n\n`;
      message += `Please let us know when we can expect your payment.\n\n`;
      message += `Thank you,\n${document.querySelector('.logo-text').textContent}`;
      
      document.getElementById('whatsappMessage').value = message;
      document.getElementById('whatsappModal').style.display = 'flex';
    }
    
    // ========== RENDER FUNCTIONS ==========
    function renderCustomers(customersToRender) {
      const loansTableBody = document.getElementById('loansTableBody');
      const customerCards = document.getElementById('customerCards');
      
      // Clear existing content
      loansTableBody.innerHTML = '';
      customerCards.innerHTML = '';
      
      if (customersToRender.length === 0) {
        const emptyMessage = `
          <tr><td colspan="8">
            <div class="empty-state">
              <i class="fas fa-user-slash"></i>
              <h3 data-translate="No Customers Found">No Customers Found</h3>
              <p data-translate="Add your first customer to get started">Add your first customer to get started</p>
            </div>
          </td></tr>`;
        
        loansTableBody.innerHTML = emptyMessage;
        customerCards.innerHTML = emptyMessage;
        return;
      }
      
      // Render desktop table
      customersToRender.forEach(customer => {
        // Calculate customer totals
        const customerLoans = loans.filter(loan => loan.customerId === customer.id);
        const given = customerLoans.filter(loan => loan.type === 'given').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const received = customerLoans.filter(loan => loan.type === 'taken').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const balance = given - received;
        
        // Determine status
        let status = 'active';
        const overdueLoans = customerLoans.filter(loan => {
          const dueDate = new Date(loan.dueDate);
          return loan.status === 'active' && dueDate < new Date();
        });
        
        if (overdueLoans.length > 0) {
          status = 'overdue';
        } else if (balance === 0 && customerLoans.length > 0) {
          status = 'closed';
        }
        
        // Last activity date
        const lastActivity = customerLoans.length > 0 ? 
          customerLoans.reduce((latest, loan) => {
            const loanDate = new Date(loan.date);
            return loanDate > latest ? loanDate : latest;
          }, new Date(0)) : null;
        
        // Create table row
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${customer.name}</td>
          <td>${customer.phone || '-'}</td>
          <td>${formatCurrency(given)}</td>
          <td>${formatCurrency(received)}</td>
          <td class="${balance >= 0 ? 'type-given' : 'type-taken'}">
            ${formatCurrency(Math.abs(balance))}
          </td>
          <td>${getStatusBadge(status)}</td>
          <td>${lastActivity ? formatDate(lastActivity) : '-'}</td>
          <td class="action-cell">
            <button class="action-btn whatsapp-btn" data-id="${customer.id}" title="Send WhatsApp reminder">
              <i class="fab fa-whatsapp"></i>
            </button>
            <button class="action-btn edit-btn" data-id="${customer.id}" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </td>`;
        
        loansTableBody.appendChild(row);
        
        // Add event listeners
        row.querySelector('.whatsapp-btn').addEventListener('click', () => openWhatsappModal(customer));
        row.querySelector('.edit-btn').addEventListener('click', () => viewCustomerDetails(customer.id));
      });
      
      // Render mobile cards
      customersToRender.forEach(customer => {
        // Calculate customer totals
        const customerLoans = loans.filter(loan => loan.customerId === customer.id);
        const given = customerLoans.filter(loan => loan.type === 'given').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const received = customerLoans.filter(loan => loan.type === 'taken').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const balance = given - received;
        
        // Determine status
        let status = 'active';
        const overdueLoans = customerLoans.filter(loan => {
          const dueDate = new Date(loan.dueDate);
          return loan.status === 'active' && dueDate < new Date();
        });
        
        if (overdueLoans.length > 0) {
          status = 'overdue';
        } else if (balance === 0 && customerLoans.length > 0) {
          status = 'closed';
        }
        
        // Create card
        const card = document.createElement('div');
        card.className = 'customer-card';
        card.innerHTML = `
          <div class="customer-header">
            <div class="customer-name">${customer.name}</div>
            <div class="customer-balance ${balance >= 0 ? 'balance-positive' : 'balance-negative'}">
              ${formatCurrency(Math.abs(balance))}
            </div>
          </div>
          <div class="customer-details">
            <div>
              <span class="detail-label" data-translate="Phone:">Phone:</span> ${customer.phone || '-'}
            </div>
            <div>
              <span class="detail-label" data-translate="Given:">Given:</span> ${formatCurrency(given)}
            </div>
            <div>
              <span class="detail-label" data-translate="Received:">Received:</span> ${formatCurrency(received)}
            </div>
            <div>
              <span class="detail-label" data-translate="Status:">Status:</span> ${getStatusBadge(status)}
            </div>
          </div>
          <div class="customer-actions">
            <button class="action-btn whatsapp-btn" data-id="${customer.id}" title="Send WhatsApp reminder">
              <i class="fab fa-whatsapp"></i>
            </button>
            <button class="action-btn edit-btn" data-id="${customer.id}" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>`;
        
        customerCards.appendChild(card);
        
        // Add event listeners
        card.querySelector('.whatsapp-btn').addEventListener('click', () => openWhatsappModal(customer));
        card.querySelector('.edit-btn').addEventListener('click', () => viewCustomerDetails(customer.id));
      });
    }
    
    function renderCustomerLedger(customerId, fromDate = null, toDate = null) {
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;
      
      // Set customer details in modal
      document.getElementById('customerDetailTitle').textContent = customer.name;
      document.getElementById('customerDetailName').textContent = customer.name;
      document.getElementById('customerDetailPhone').innerHTML = customer.phone ? `<i class="fas fa-phone"></i> ${customer.phone}` : '<i class="fas fa-phone"></i> Not provided';
      document.getElementById('customerDetailAddress').innerHTML = customer.address ? `<i class="fas fa-map-marker-alt"></i> ${customer.address}` : '<i class="fas fa-map-marker-alt"></i> Not provided';
      document.getElementById('customerDetailPhoto').src = customer.photoURL || 'https://via.placeholder.com/150';
      
      // Filter loans and repayments by date range
      let customerLoans = loans.filter(loan => loan.customerId === customerId);
      let customerRepayments = repayments.filter(repayment => repayment.customerId === customerId);
      
      if (fromDate) {
        const from = new Date(fromDate);
        customerLoans = customerLoans.filter(loan => new Date(loan.date) >= from);
        customerRepayments = customerRepayments.filter(repayment => new Date(repayment.paidAt) >= from);
      }
      
      if (toDate) {
        const to = new Date(toDate);
        customerLoans = customerLoans.filter(loan => new Date(loan.date) <= to);
        customerRepayments = customerRepayments.filter(repayment => new Date(repayment.paidAt) <= to);
      }
      
      // Calculate totals
      const given = customerLoans.filter(loan => loan.type === 'given').reduce((sum, loan) => sum + (loan.total || 0), 0);
      const received = customerLoans.filter(loan => loan.type === 'taken').reduce((sum, loan) => sum + (loan.total || 0), 0);
      const balance = given - received;
      
      document.getElementById('customerTotalGiven').textContent = formatCurrency(given);
      document.getElementById('customerTotalReceived').textContent = formatCurrency(received);
      document.getElementById('customerBalance').textContent = formatCurrency(balance);
      
      // Combine loans and repayments into ledger entries
      const ledgerEntries = [];
      
      customerLoans.forEach(loan => {
        ledgerEntries.push({
          date: loan.date,
          type: 'loan',
          amount: loan.type === 'given' ? loan.total : -loan.total,
          note: loan.note || 'Loan'
        });
      });
      
      customerRepayments.forEach(repayment => {
        ledgerEntries.push({
          date: repayment.paidAt,
          type: 'repayment',
          amount: repayment.amount,
          note: repayment.note || 'Repayment'
        });
      });
      
      // Sort by date
      ledgerEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Calculate running balance
      let runningBalance = 0;
      ledgerEntries.forEach(entry => {
        runningBalance += entry.amount;
        entry.balance = runningBalance;
      });
      
      // Reverse to show oldest first
      ledgerEntries.reverse();
      
      // Render ledger
      const customerLedgerBody = document.getElementById('customerLedgerBody');
      customerLedgerBody.innerHTML = '';
      
      if (ledgerEntries.length === 0) {
        customerLedgerBody.innerHTML = `
          <tr><td colspan="5">
            <div class="empty-state">
              <i class="fas fa-file-invoice-dollar"></i>
              <h3 data-translate="No Transactions Found">No Transactions Found</h3>
            </div>
          </td></tr>`;
        return;
      }
      
      ledgerEntries.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatDate(entry.date)}</td>
          <td>${entry.type === 'loan' ? 'Loan' : 'Repayment'}</td>
          <td class="${entry.amount >= 0 ? 'type-given' : 'type-taken'}">
            ${formatCurrency(Math.abs(entry.amount))}
          </td>
          <td class="${entry.balance >= 0 ? 'type-given' : 'type-taken'}">
            ${formatCurrency(Math.abs(entry.balance))}
          </td>
          <td>${entry.note}</td>`;
        
        customerLedgerBody.appendChild(row);
      });
    }
    
    function renderLoanCustomerDropdown() {
      const loanCustomer = document.getElementById('loanCustomer');
      const repaymentCustomer = document.getElementById('repaymentCustomer');
      
      loanCustomer.innerHTML = '<option value="" data-translate="Select Customer">Select Customer</option>';
      repaymentCustomer.innerHTML = '<option value="" data-translate="Select Customer">Select Customer</option>';
      
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        
        loanCustomer.appendChild(option.cloneNode(true));
        repaymentCustomer.appendChild(option);
      });
    }
    
    function renderLoanProductsDropdown() {
      const productItems = document.getElementById('productItems');
      productItems.innerHTML = '';
      addProductRow();
    }
    
    function addProductRow(product = null) {
      const productItems = document.getElementById('productItems');
      const row = document.createElement('div');
      row.className = 'product-item';
      
      // Product select
      const productSelect = document.createElement('select');
      productSelect.className = 'product-select';
      productSelect.innerHTML = '<option value="" data-translate="Select Product">Select Product</option>';
      
      products.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod.id;
        option.textContent = prod.name;
        option.dataset.rate = prod.rate;
        if (product && product.productId === prod.id) {
          option.selected = true;
        }
        productSelect.appendChild(option);
      });
      
      // Quantity input
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.className = 'product-qty';
      qtyInput.placeholder = 'Qty';
      qtyInput.min = '1';
      qtyInput.value = product?.qty || '1';
      qtyInput.required = true;
      
      // Rate input
      const rateInput = document.createElement('input');
      rateInput.type = 'number';
      rateInput.className = 'product-rate';
      rateInput.placeholder = 'Rate';
      rateInput.min = '0';
      rateInput.step = '0.01';
      rateInput.value = product?.rate || '';
      rateInput.required = true;
      
      // Remove button
      const removeBtn = document.createElement('i');
      removeBtn.className = 'fas fa-times product-remove';
      removeBtn.title = 'Remove product';
      
      // Add to row
      row.appendChild(productSelect);
      row.appendChild(qtyInput);
      row.appendChild(rateInput);
      row.appendChild(removeBtn);
      
      // Add event listeners
      productSelect.addEventListener('change', (e) => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        if (selectedOption.dataset.rate) {
          rateInput.value = selectedOption.dataset.rate;
          calculateLoanTotal();
        }
      });
      
      qtyInput.addEventListener('input', calculateLoanTotal);
      rateInput.addEventListener('input', calculateLoanTotal);
      removeBtn.addEventListener('click', () => {
        row.remove();
        calculateLoanTotal();
      });
      
      productItems.appendChild(row);
      calculateLoanTotal();
    }
    
    function renderLoanDropdown(customerId) {
      const repaymentLoan = document.getElementById('repaymentLoan');
      repaymentLoan.innerHTML = '<option value="" data-translate="Select Loan">Select Loan</option>';
      
      if (!customerId) return;
      
      const customerLoans = loans.filter(loan => loan.customerId === customerId && loan.status === 'active');
      
      customerLoans.forEach(loan => {
        const option = document.createElement('option');
        option.value = loan.id;
        option.textContent = `${formatDate(loan.date)} - ${formatCurrency(loan.total)} (Due: ${loan.dueDate ? formatDate(loan.dueDate) : 'None'})`;
        repaymentLoan.appendChild(option);
      });
    }
    
    // ========== DATA OPERATIONS ==========
    async function saveCustomer() {
      const user = auth.currentUser;
      if (!user) return alert("Please log in to save customers.");
      
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      
      // Validation
      let isValid = true;
      if (!name) {
        document.getElementById('customerName').classList.add('input-error');
        document.getElementById('nameError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('customerName').classList.remove('input-error');
        document.getElementById('nameError').style.display = 'none';
      }
      
      if (!phone) {
        document.getElementById('customerPhone').classList.add('input-error');
        document.getElementById('phoneError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('customerPhone').classList.remove('input-error');
        document.getElementById('phoneError').style.display = 'none';
      }
      
      if (!isValid) return;
      
      const customerData = {
        name,
        phone,
        address: document.getElementById('customerAddress').value.trim(),
        openingBalance: parseFloat(document.getElementById('openingBalance').value) || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        if (editingCustomerId) {
          await db.collection("customers").doc(editingCustomerId).update(customerData);
          showToast("Customer updated successfully!");
        } else {
          await db.collection("customers").add(customerData);
          showToast("Customer added successfully!");
        }
        
        document.getElementById('customerModal').style.display = 'none';
      } catch (error) {
        console.error("Error saving customer:", error);
        alert("Error saving customer: " + error.message);
      }
    }
    
    async function saveLoan() {
      const user = auth.currentUser;
      if (!user) return alert("Please log in to save loans.");
      
      // Validate customer selection
      const loanCustomer = document.getElementById('loanCustomer').value;
      const loanDate = document.getElementById('loanDate').value;
      
      let isValid = true;
      if (!loanCustomer) {
        document.getElementById('loanCustomer').classList.add('input-error');
        document.getElementById('customerError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('loanCustomer').classList.remove('input-error');
        document.getElementById('customerError').style.display = 'none';
      }
      
      if (!loanDate) {
        document.getElementById('loanDate').classList.add('input-error');
        document.getElementById('dateError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('loanDate').classList.remove('input-error');
        document.getElementById('dateError').style.display = 'none';
      }
      
      // Collect product items
      const items = [];
      const productItems = document.getElementById('productItems');
      const productRows = productItems.querySelectorAll('.product-item');
      
      productRows.forEach(row => {
        const productId = row.querySelector('.product-select').value;
        const productName = row.querySelector('.product-select').options[row.querySelector('.product-select').selectedIndex]?.text || 'Custom';
        const qty = parseFloat(row.querySelector('.product-qty').value) || 0;
        const rate = parseFloat(row.querySelector('.product-rate').value) || 0;
        
        if (productId && qty > 0 && rate > 0) {
          items.push({
            productId,
            name: productName,
            qty,
            rate
          });
        }
      });
      
      if (items.length === 0) {
        document.getElementById('productError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('productError').style.display = 'none';
      }
      
      if (!isValid) return;
      
      // Calculate totals
      const subtotal = items.reduce((sum, item) => sum + (item.qty * item.rate), 0);
      const discount = parseFloat(document.getElementById('loanDiscount').value) || 0;
      const tax = parseFloat(document.getElementById('loanTax').value) || 0;
      const total = subtotal - discount + (subtotal * (tax / 100));
      
      // Determine status
      let status = 'active';
      if (document.getElementById('loanDueDate').value) {
        const dueDate = new Date(document.getElementById('loanDueDate').value);
        if (dueDate < new Date()) {
          status = 'overdue';
        }
      }
      
      const loanData = {
        customerId: loanCustomer,
        date: loanDate,
        dueDate: document.getElementById('loanDueDate').value || null,
        items,
        subtotal,
        discount,
        tax,
        total,
        status,
        note: document.getElementById('loanNote').value.trim(),
        type: 'given', // Assuming all loans are given in this system
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        if (editingLoanId) {
          await db.collection("loans").doc(editingLoanId).update(loanData);
          showToast("Loan updated successfully!");
        } else {
          await db.collection("loans").add(loanData);
          showToast("Loan added successfully!");
        }
        
        document.getElementById('loanModal').style.display = 'none';
      } catch (error) {
        console.error("Error saving loan:", error);
        alert("Error saving loan: " + error.message);
      }
    }
    
    async function saveRepayment() {
      const user = auth.currentUser;
      if (!user) return alert("Please log in to record repayments.");
      
      // Validate inputs
      const repaymentCustomer = document.getElementById('repaymentCustomer').value;
      const repaymentLoan = document.getElementById('repaymentLoan').value;
      const repaymentAmount = parseFloat(document.getElementById('repaymentAmount').value);
      const repaymentDate = document.getElementById('repaymentDate').value;
      
      let isValid = true;
      
      if (!repaymentCustomer) {
        document.getElementById('repaymentCustomer').classList.add('input-error');
        document.getElementById('repaymentCustomerError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('repaymentCustomer').classList.remove('input-error');
        document.getElementById('repaymentCustomerError').style.display = 'none';
      }
      
      if (!repaymentLoan) {
        document.getElementById('repaymentLoan').classList.add('input-error');
        document.getElementById('repaymentLoanError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('repaymentLoan').classList.remove('input-error');
        document.getElementById('repaymentLoanError').style.display = 'none';
      }
      
      if (isNaN(repaymentAmount) || repaymentAmount <= 0) {
        document.getElementById('repaymentAmount').classList.add('input-error');
        document.getElementById('repaymentAmountError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('repaymentAmount').classList.remove('input-error');
        document.getElementById('repaymentAmountError').style.display = 'none';
      }
      
      if (!repaymentDate) {
        document.getElementById('repaymentDate').classList.add('input-error');
        document.getElementById('repaymentDateError').style.display = 'block';
        isValid = false;
      } else {
        document.getElementById('repaymentDate').classList.remove('input-error');
        document.getElementById('repaymentDateError').style.display = 'none';
      }
      
      if (!isValid) return;
      
      const repaymentData = {
        customerId: repaymentCustomer,
        loanId: repaymentLoan,
        amount: repaymentAmount,
        paidAt: repaymentDate,
        method: document.getElementById('repaymentMethod').value,
        note: document.getElementById('repaymentNote').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        await db.collection("repayments").add(repaymentData);
        showToast("Repayment recorded successfully!");
        document.getElementById('repaymentModal').style.display = 'none';
      } catch (error) {
        console.error("Error saving repayment:", error);
        alert("Error saving repayment: " + error.message);
      }
    }
    
    function sendWhatsappMessage() {
      if (!selectedCustomer?.phone) {
        alert("Customer doesn't have a phone number saved.");
        return;
      }
      
      const message = encodeURIComponent(document.getElementById('whatsappMessage').value);
      const phone = selectedCustomer.phone.replace(/[^0-9]/g, '');
      
      // Create WhatsApp deep link
      const whatsappUrl = `https://wa.me/${phone}?text=${message}`;
      
      // Try to open WhatsApp, fallback to copy to clipboard
      window.open(whatsappUrl, '_blank');
      
      // Fallback: Copy message to clipboard
      navigator.clipboard.writeText(document.getElementById('whatsappMessage').value)
        .then(() => {
          showToast("Message copied to clipboard. Please paste it in WhatsApp.");
        })
        .catch(err => {
          console.error("Could not copy text: ", err);
        });
      
      document.getElementById('whatsappModal').style.display = 'none';
    }
    
    function exportCustomerPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      
      // Customer info
      doc.setFontSize(18).text(selectedCustomer.name, 40, 40);
      doc.setFontSize(12).setTextColor(100).text(`Phone: ${selectedCustomer.phone || 'Not provided'}`, 40, 60);
      doc.text(`Address: ${selectedCustomer.address || 'Not provided'}`, 40, 80);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, 40, 100);
      
      // Summary
      doc.setFontSize(14).setTextColor(0).text('Summary', 40, 130);
      doc.setFontSize(12).text(`Total Given: ${document.getElementById('customerTotalGiven').textContent}`, 50, 155);
      doc.text(`Total Received: ${document.getElementById('customerTotalReceived').textContent}`, 50, 175);
      doc.text(`Balance: ${document.getElementById('customerBalance').textContent}`, 50, 195);
      
      // Ledger table
      doc.setTextColor(255).setFillColor(37, 99, 235).rect(40, 220, 520, 20, 'F');
      doc.text('Date', 45, 233);
      doc.text('Type', 150, 233);
      doc.text('Amount', 300, 233);
      doc.text('Balance', 400, 233);
      doc.text('Note', 500, 233);
      
      // Ledger entries
      doc.setTextColor(0);
      let y = 250;
      const customerLedgerBody = document.getElementById('customerLedgerBody');
      const rows = customerLedgerBody.querySelectorAll('tr');
      
      rows.forEach(row => {
        if (y > 700) { doc.addPage(); y = 40; }
        
        const cells = row.querySelectorAll('td');
        if (cells.length === 5) {
          doc.setFontSize(10);
          doc.text(cells[0].textContent, 45, y);
          doc.text(cells[1].textContent, 150, y);
          doc.text(cells[2].textContent, 300, y);
          doc.text(cells[3].textContent, 400, y);
          doc.text(cells[4].textContent, 500, y);
          y += 20;
        }
      });
      
      doc.save(`EasyKharcha-${selectedCustomer.name}-${new Date().toISOString().slice(0, 10)}.pdf`);
    }
    
    // ========== STATS FUNCTIONS ==========
    function updateStats() {
      const given = loans.filter(loan => loan.type === 'given').reduce((sum, loan) => sum + (loan.total || 0), 0);
      const received = loans.filter(loan => loan.type === 'taken').reduce((sum, loan) => sum + (loan.total || 0), 0);
      const balance = given - received;
      
      document.getElementById('totalGiven').textContent = formatCurrency(given);
      document.getElementById('totalReceived').textContent = formatCurrency(received);
      document.getElementById('netBalance').textContent = formatCurrency(balance);
      
      // Optional: Monthly trend calculation
      const now = new Date();
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      
      const lastMonthGiven = loans.filter(l => l.type === 'given' && new Date(l.date) >= lastMonth)
                          .reduce((sum, l) => sum + (l.total || 0), 0);
      
      const lastMonthReceived = loans.filter(l => l.type === 'taken' && new Date(l.date) >= lastMonth)
                            .reduce((sum, l) => sum + (l.total || 0), 0);
      
      const givenTrend = given ? Math.round((lastMonthGiven / given) * 100) : 0;
      const receivedTrend = received ? Math.round((lastMonthReceived / received) * 100) : 0;
      const balanceTrend = balance ? Math.round(((lastMonthGiven - lastMonthReceived) / balance) * 100) : 0;
      
      document.getElementById('givenTrend').innerHTML = `<i class="fas fa-arrow-up"></i> ${givenTrend}% from last month`;
      document.getElementById('receivedTrend').innerHTML = `<i class="fas fa-arrow-down"></i> ${receivedTrend}% from last month`;
      document.getElementById('balanceTrend').innerHTML = `<i class="fas fa-arrow-up"></i> ${balanceTrend}% from last month`;
    }
    
    // ========== FILTER FUNCTIONS ==========
    function filterCustomers() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const typeValue = document.getElementById('typeFilter').value;
      const statusValue = document.getElementById('statusFilter').value;
      const fromDate = document.getElementById('dateFrom').value;
      const toDate = document.getElementById('dateTo').value;
      const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
      const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
      
      const filtered = customers.filter(customer => {
        // Search by name or phone
        const matchesSearch = customer.name.toLowerCase().includes(searchTerm) || 
                            (customer.phone && customer.phone.toLowerCase().includes(searchTerm));
        
        // Filter by loan type (given/taken)
        const customerLoans = loans.filter(loan => loan.customerId === customer.id);
        const given = customerLoans.filter(loan => loan.type === 'given').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const received = customerLoans.filter(loan => loan.type === 'taken').reduce((sum, loan) => sum + (loan.total || 0), 0);
        const balance = given - received;
        
        let matchesType = true;
        if (typeValue === 'given') {
          matchesType = balance > 0;
        } else if (typeValue === 'taken') {
          matchesType = balance < 0;
        }
        
        // Filter by status
        let status = 'active';
        const overdueLoans = customerLoans.filter(loan => {
          const dueDate = new Date(loan.dueDate);
          return loan.status === 'active' && dueDate < new Date();
        });
        
        if (overdueLoans.length > 0) {
          status = 'overdue';
        } else if (balance === 0 && customerLoans.length > 0) {
          status = 'closed';
        }
        
        const matchesStatus = statusValue === 'all' || status === statusValue;
        
        // Filter by amount range
        const matchesAmount = Math.abs(balance) >= minAmount && Math.abs(balance) <= maxAmount;
        
        // Filter by date range
        let matchesDate = true;
        if (fromDate || toDate) {
          const hasLoansInRange = customerLoans.some(loan => {
            const loanDate = new Date(loan.date);
            const from = fromDate ? new Date(fromDate) : new Date(0);
            const to = toDate ? new Date(toDate) : new Date();
            return loanDate >= from && loanDate <= to;
          });
          
          matchesDate = hasLoansInRange;
        }
        
        return matchesSearch && matchesType && matchesStatus && matchesAmount && matchesDate;
      });
      
      renderCustomers(filtered);
    }
    
    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      // Toggle advanced filters
      document.getElementById('toggleFilters').addEventListener('click', () => {
        document.getElementById('advancedFilters').classList.toggle('show');
      });
      
      // Apply filters
      document.getElementById('applyFilters').addEventListener('click', filterCustomers);
      document.getElementById('searchInput').addEventListener('input', filterCustomers);
      document.getElementById('typeFilter').addEventListener('change', filterCustomers);
      document.getElementById('statusFilter').addEventListener('change', filterCustomers);
      document.getElementById('dateFrom').addEventListener('change', filterCustomers);
      document.getElementById('dateTo').addEventListener('change', filterCustomers);
      document.getElementById('minAmount').addEventListener('input', filterCustomers);
      document.getElementById('maxAmount').addEventListener('input', filterCustomers);
      
      // Customer form
      document.getElementById('customerForm').addEventListener('submit', (e) => {
        e.preventDefault();
        saveCustomer();
      });
      
      document.getElementById('cancelCustomer').addEventListener('click', () => {
        document.getElementById('customerModal').style.display = 'none';
      });
      
      // Loan form
      document.getElementById('loanForm').addEventListener('submit', (e) => {
        e.preventDefault();
        saveLoan();
      });
      
      document.getElementById('cancelLoan').addEventListener('click', () => {
        document.getElementById('loanModal').style.display = 'none';
      });
      
      document.getElementById('addProduct').addEventListener('click', () => {
        addProductRow();
      });
      
      // Repayment form
      document.getElementById('repaymentForm').addEventListener('submit', (e) => {
        e.preventDefault();
        saveRepayment();
      });
      
      document.getElementById('cancelRepayment').addEventListener('click', () => {
        document.getElementById('repaymentModal').style.display = 'none';
      });
      
      document.getElementById('repaymentCustomer').addEventListener('change', (e) => {
        renderLoanDropdown(e.target.value);
      });
      
      // Customer detail modal
      document.getElementById('applyCustomerFilter').addEventListener('click', () => {
        renderCustomerLedger(
          selectedCustomer.id,
          document.getElementById('customerDateFrom').value,
          document.getElementById('customerDateTo').value
        );
      });
      
      document.getElementById('whatsappCustomer').addEventListener('click', () => {
        openWhatsappModal(selectedCustomer);
      });
      
      document.getElementById('exportCustomerPDF').addEventListener('click', exportCustomerPDF);
      document.getElementById('addCustomerTransaction').addEventListener('click', () => {
        document.getElementById('customerDetailModal').style.display = 'none';
        openLoanModal();
      });
      
      // WhatsApp modal
      document.getElementById('sendWhatsapp').addEventListener('click', sendWhatsappMessage);
      document.getElementById('cancelWhatsapp').addEventListener('click', () => {
        document.getElementById('whatsappModal').style.display = 'none';
      });
      
      // Close modals when clicking outside
      window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('customerModal')) document.getElementById('customerModal').style.display = 'none';
        if (e.target === document.getElementById('loanModal')) document.getElementById('loanModal').style.display = 'none';
        if (e.target === document.getElementById('repaymentModal')) document.getElementById('repaymentModal').style.display = 'none';
        if (e.target === document.getElementById('customerDetailModal')) document.getElementById('customerDetailModal').style.display = 'none';
        if (e.target === document.getElementById('whatsappModal')) document.getElementById('whatsappModal').style.display = 'none';
      });
      
      // FAB actions
      document.getElementById('addCustomerBtn').addEventListener('click', () => {
        openCustomerModal();
        document.getElementById('fabButton').blur();
      });
      
      document.getElementById('addLoanBtn').addEventListener('click', () => {
        openLoanModal();
        document.getElementById('fabButton').blur();
      });
      
      document.getElementById('addRepaymentBtn').addEventListener('click', () => {
        openRepaymentModal();
        document.getElementById('fabButton').blur();
      });
      
      // Close buttons
      document.getElementById('closeCustomerModal').addEventListener('click', () => {
        document.getElementById('customerModal').style.display = 'none';
      });
      
      document.getElementById('closeLoanModal').addEventListener('click', () => {
        document.getElementById('loanModal').style.display = 'none';
      });
      
      document.getElementById('closeRepaymentModal').addEventListener('click', () => {
        document.getElementById('repaymentModal').style.display = 'none';
      });
      
      document.getElementById('closeCustomerDetailModal').addEventListener('click', () => {
        document.getElementById('customerDetailModal').style.display = 'none';
      });
      
      document.getElementById('closeWhatsappModal').addEventListener('click', () => {
        document.getElementById('whatsappModal').style.display = 'none';
      });
    }
    
    // ========== INITIALIZATION ==========
    function init() {
      // Set default dates for filters
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      
      document.getElementById('dateFrom').valueAsDate = lastMonth;
      document.getElementById('dateTo').valueAsDate = today;
      
      // Set default dates in forms
      document.getElementById('loanDate').valueAsDate = today;
      document.getElementById('repaymentDate').valueAsDate = today;
      
      // Set default due date (30 days from now)
      const dueDate = new Date();
      dueDate.setDate(today.getDate() + 30);
      document.getElementById('loanDueDate').valueAsDate = dueDate;
      
      // Setup event listeners
      setupEventListeners();
      
      // Check auth state
      auth.onAuthStateChanged(user => {
        if (user) {
          // First fetch user settings
          db.collection("users").doc(user.uid).get()
            .then(doc => {
              const settings = doc.exists ? doc.data().settings || {} : {};
              // Apply settings to the page
              applySettings(settings);
              
              // Then fetch data
              // Customers with real-time updates
              db.collection("customers").onSnapshot(snap => {
                customers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCustomers(customers);
                renderLoanCustomerDropdown();
              });
              
              // Loans with real-time updates
              db.collection("loans").onSnapshot(snap => {
                loans = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStats();
                filterCustomers();
              });
              
              // Repayments with real-time updates
              db.collection("repayments").onSnapshot(snap => {
                repayments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update loan statuses
                loans.forEach(loan => {
                  updateLoanStatus(loan.id);
                });
              });
              
              // Products with real-time updates
              db.collection("products").onSnapshot(snap => {
                products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLoanProductsDropdown();
              });
            })
            .catch(error => {
              console.error("Error loading settings:", error);
              // Proceed with default settings
              applySettings({ darkMode: false, language: 'en' });
              
              // Fetch data with real-time updates
              db.collection("customers").onSnapshot(snap => {
                customers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCustomers(customers);
                renderLoanCustomerDropdown();
              });
              
              db.collection("loans").onSnapshot(snap => {
                loans = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStats();
                filterCustomers();
              });
              
              db.collection("repayments").onSnapshot(snap => {
                repayments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Update loan statuses
                loans.forEach(loan => {
                  updateLoanStatus(loan.id);
                });
              });
              
              db.collection("products").onSnapshot(snap => {
                products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLoanProductsDropdown();
              });
            });
        } else {
          // Redirect to login if not authenticated
          window.location.href = "login.html";
        }
      });
    }
    
    function applySettings(settings) {
      // Apply dark mode
      if (settings.darkMode) {
        document.documentElement.classList.add('dark-mode');
      } else {
        document.documentElement.classList.remove('dark-mode');
      }
      
      // Apply language
      document.documentElement.classList.remove('urdu-mode');
      if (settings.language === 'ur') {
        document.documentElement.classList.add('urdu-mode');
        translatePage('ur');
      }
    }
    
    function translatePage(lang) {
      const translations = {
        ur: {
          "Loan Management": "  ",
          "Total Given": "  ",
          "Total Received": "  ",
          "Net Balance": " ",
          "Filter by:": " :",
          "All Loans": " ",
          "Given Loans": "  ",
          "Taken Loans": "  ",
          "All Status": " ",
          "Active Loans": " ",
          "Closed Loans": " ",
          "Overdue Loans": "  ",
          "Apply": " ",
          "Search by name or phone...": "     ...",
          "Advanced Filters": "   ",
          "From Date": " ",
          "To Date": " ",
          "Min Amount": "   ",
          "Max Amount": "   ",
          "Add Customer": "  ",
          "New Loan": " ",
          "Record Repayment": "  ",
          "Full Name": " ",
          "Phone Number": " ",
          "Address (Optional)": " ()",
          "Photo (Optional)": " ()",
          "Opening Balance": " ",
          "Save Customer": "  ",
          "Customer": "",
          "Select Customer": "  ",
          "Date": "",
          "Due Date": "  ",
          "Products": "",
          "Add Product": "  ",
          "Discount": "",
          "Tax": "",
          "Total Amount": " ",
          "Notes (Optional)": " ()",
          "Save Loan": "  ",
          "Loan": "",
          "Select Loan": "  ",
          "Amount": "",
          "Payment Method": "  ",
          "Cash": "",
          "Bank Transfer": " ",
          "Cheque": "",
          "UPI": "  ",
          "Other": "",
          "Record Payment": "  ",
          "Customer Details": "  ",
          "Balance": "",
          "Date Range": "  ",
          "Send Reminder": "  ",
          "Export PDF": "    ",
          "Add Transaction": "  ",
          "Send WhatsApp Reminder": "   ",
          "This message will be sent to the customer:": "      :",
          "Note: You'll need to select the contact manually in WhatsApp": ":            ",
          "Cancel": " ",
          "Open WhatsApp": "  ",
          "Dashboard": " ",
          "Loan": "",
          "Profile": "",
          "Type": "",
          "Note": ""
        }
      };
      
      const dict = translations[lang];
      if (!dict) return;
      
      // Translate elements with data-translate attribute
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (dict[key]) {
          el.textContent = dict[key];
        }
      });
      
      // Translate placeholders
      document.querySelectorAll('[data-placeholder]').forEach(el => {
        const key = el.getAttribute('data-placeholder');
        if (dict[key]) {
          el.setAttribute('placeholder', dict[key]);
        }
      });
    }
    
    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
